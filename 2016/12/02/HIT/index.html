<!DOCTYPE html><html style="display:none" lang="zh"><head><meta charset="utf-8"><script>window.materialVersion="1.5.2",window.oldVersion=["codestartv1","1.3.4","1.4.0","1.4.0b1","1.5.0"]</script><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="http://pd3i7mmdp.bkt.clouddn.com"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>HIT图形分析 | Loading &amp; Learning</title><link rel="icon shortcut" type="image/ico" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="format-detection" content="telephone=no"><meta name="description" itemprop="description" content="填坑向…之前和群里一个朋友讨论HIT的影子是咋实现的，后来验证了下发现自己之前想错了(逃。后来还看了下它的Bloom做法，效果还是挺好的。这里大力感谢@Hinatia和@LeLe给予的帮助和点拨，嘿嘿"><meta name="keywords" content="null,Unreal"><meta name="theme-color" content="#0097A7"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]--><script>window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}},lsloader.removeLS=function(e){try{localStorage.removeItem(e)}catch(e){}},lsloader.setLS=function(e,t){try{localStorage.setItem(e,t)}catch(e){}},lsloader.getLS=function(e){var t="";try{t=localStorage.getItem(e)}catch(e){t=""}return t},versionString="/*"+(window.materialVersion||"unknownVersion")+"*/",lsloader.clean=function(){try{for(var e=[],t=0;t<localStorage.length;t++)e.push(localStorage.key(t));e.forEach(function(e){var n=lsloader.getLS(e);window.oldVersion&&window.oldVersion.reduce(function(e,t){return e||-1!==n.indexOf("/*"+t+"*/")},!1)&&lsloader.removeLS(e)})}catch(e){}},lsloader.clean(),lsloader.load=function(e,t,n,s){var a;if("boolean"==typeof n&&(s=n,n=void 0),s=s||!1,n=n||function(){},(a=this.getLS(e))&&-1===a.indexOf(versionString))return this.removeLS(e),void this.requestResource(e,t,n,s);if(a){if(a.split(versionString)[0]!=t)return console.log("reload:"+t),this.removeLS(e),void this.requestResource(e,t,n,s);a=a.split(versionString)[1],s?(this.jsRunSequence.push({name:e,code:a}),this.runjs(t,e,a)):(document.getElementById(e).appendChild(document.createTextNode(a)),n())}else this.requestResource(e,t,n,s)},lsloader.requestResource=function(t,n,e,s){var a=this;s?this.iojs(n,t,function(e,t,n){a.setLS(t,e+versionString+n),a.runjs(e,t,n)}):this.iocss(n,t,function(e){document.getElementById(t).appendChild(document.createTextNode(e)),a.setLS(t,n+versionString+e)},e)},lsloader.iojs=function(e,t,n){var s=this;s.jsRunSequence.push({name:t,code:""});try{var a=new XMLHttpRequest;a.open("get",e,!0),a.onreadystatechange=function(){if(4==a.readyState){if((200<=a.status&&a.status<300||304==a.status)&&""!=a.response)return void n(e,t,a.response);s.jsfallback(e,t)}},a.send(null)}catch(n){s.jsfallback(e,t)}},lsloader.iocss=function(e,t,n,s){var a=this;try{var o=new XMLHttpRequest;o.open("get",e,!0),o.onreadystatechange=function(){if(4==o.readyState){if((200<=o.status&&o.status<300||304==o.status)&&""!=o.response)return n(o.response),void s();a.cssfallback(e,t,s)}},o.send(null)}catch(n){a.cssfallback(e,t,s)}},lsloader.iofonts=function(e,t,n,s){var a=this;try{var o=new XMLHttpRequest;o.open("get",e,!0),o.onreadystatechange=function(){if(4==o.readyState){if((200<=o.status&&o.status<300||304==o.status)&&""!=o.response)return n(o.response),void s();a.cssfallback(e,t,s)}},o.send(null)}catch(n){a.cssfallback(e,t,s)}},lsloader.runjs=function(e,t,n){if(t&&n)for(var s in this.jsRunSequence)this.jsRunSequence[s].name==t&&(this.jsRunSequence[s].code=n);if(this.jsRunSequence[0]&&this.jsRunSequence[0].code&&"failed"!=this.jsRunSequence[0].status)(a=document.createElement("script")).appendChild(document.createTextNode(this.jsRunSequence[0].code)),a.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(a),this.jsRunSequence.shift(),0<this.jsRunSequence.length&&this.runjs();else if(this.jsRunSequence[0]&&"failed"==this.jsRunSequence[0].status){var a,o=this;(a=document.createElement("script")).src=this.jsRunSequence[0].path,a.type="text/javascript",this.jsRunSequence[0].status="loading",a.onload=function(){o.jsRunSequence.shift(),0<o.jsRunSequence.length&&o.runjs()},document.body.appendChild(a)}},lsloader.tagLoad=function(e,t){this.jsRunSequence.push({name:t,code:"",path:e,status:"failed"}),this.runjs()},lsloader.jsfallback=function(e,t){if(!this.jsnamemap[t]){for(var n in this.jsnamemap[t]=t,this.jsRunSequence)this.jsRunSequence[n].name==t&&(this.jsRunSequence[n].code="",this.jsRunSequence[n].status="failed",this.jsRunSequence[n].path=e);this.runjs()}},lsloader.cssfallback=function(e,t,n){if(!this.cssnamemap[t]){this.cssnamemap[t]=1;var s=document.createElement("link");s.type="text/css",s.href=e,s.rel="stylesheet",s.onload=s.onerror=n;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(s,a)}},lsloader.runInlineScript=function(e,t){var n=document.getElementById(t).innerText;this.jsRunSequence.push({name:e,code:n}),this.runjs()}</script><script>function Queue(){this.dataStore=[],this.offer=function(e){this.debug&&console.log("Offered a Queued Function."),"function"==typeof e?this.dataStore.push(e):console.log("You must offer a function.")},this.poll=function(){return this.debug&&console.log("Polled a Queued Function."),this.dataStore.shift()},this.execNext=function(){var e=this.poll();void 0!==e&&(this.debug&&console.log("Run a Queued Function."),e())},this.debug=!1,this.startDebug=function(){this.debug=!0}}var queue=new Queue</script><style id="material_css"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("material_css","http://pd3i7mmdp.bkt.clouddn.com/css/material.min.css",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")},!1)</script><style id="style_css"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("style_css","http://pd3i7mmdp.bkt.clouddn.com/css/style.min.css",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")},!1)</script><style id="prettify_css"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("prettify_css","http://pd3i7mmdp.bkt.clouddn.com/css/prettify.min.css",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")},!1)</script><style id="prettify_theme"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("prettify_theme","http://pd3i7mmdp.bkt.clouddn.com/css/prettify/atelier-estuary-light.min.css",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")},!1)</script><style>body,html{font-family:Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;overflow-x:hidden!important}code{font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace}a{color:#00838f}#scheme-Paradox .hot_tags-count,#scheme-Paradox .sidebar-colored .sidebar-badge,#scheme-Paradox .sidebar-colored .sidebar-header,#scheme-Paradox .sidebar_archives-count,#search-form-label:after,#search-label,.mdl-card__media{background-color:#eee!important}#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus,#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover{color:#eee!important}#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a,#post_entry-right-info,.sidebar-colored .sidebar-nav li:hover>a,.sidebar-colored .sidebar-nav li:hover>a i,.sidebar-colored .sidebar-nav li>a:focus i,.sidebar-colored .sidebar-nav li>a:hover,.sidebar-colored .sidebar-nav li>a:hover i,.sidebar-colored .sidebar-nav>.open>a,.sidebar-colored .sidebar-nav>.open>a:focus,.sidebar-colored .sidebar-nav>.open>a:hover{color:#eee!important}.toTop{background:#757575!important}.material-layout .material-index>.material-nav,.material-layout .material-post>.material-nav,.material-nav a{color:#757575}#scheme-Paradox .MD-burger-layer{background-color:#757575}#scheme-Paradox #post-toc-trigger-btn{color:#757575}.post-toc a:hover{color:#00838f;text-decoration:underline}</style><style>body{background-color:#f5f5f5}#scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{background-color:#fff}</style><style>.fade{transition:all .8s linear;-webkit-transform:translate3d(0,0,0);-moz-transform:translate3d(0,0,0);-ms-transform:translate3d(0,0,0);-o-transform:translate3d(0,0,0);transform:translate3d(0,0,0);opacity:1}.fade.out{opacity:0}</style><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet"><style id="material_icons"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("material_icons","http://pd3i7mmdp.bkt.clouddn.com/css/material-icons.css",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")},!1)</script><script>lsloader.load("jq_js","https://cdn.bootcss.com/jquery/2.2.0/jquery.min.js",!0)</script><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="Loading &amp; Learning"><meta name="msapplication-starturl" content="http://qiankanglai.me/2016/12/02/HIT/"><meta name="msapplication-navbutton-color" content="#0097A7"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Loading &amp; Learning"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/img/favicon.png"><meta property="og:url" content="http://qiankanglai.me/2016/12/02/HIT/"><meta property="og:type" content="blog"><meta property="og:title" content="HIT图形分析 | Loading &amp; Learning"><meta property="og:image" content="/img/favicon.png"><meta property="og:description" content="填坑向…之前和群里一个朋友讨论HIT的影子是咋实现的，后来验证了下发现自己之前想错了(逃。后来还看了下它的Bloom做法，效果还是挺好的。这里大力感谢@Hinatia和@LeLe给予的帮助和点拨，嘿嘿"><meta property="og:article:tag" content="Unreal"><meta property="article:published_time" content="Fri Dec 02 2016 00:00:00 GMT+0800"><meta property="article:modified_time" content="Tue Aug 07 2018 23:11:18 GMT+0800"><meta name="twitter:card" content="summary_large_image"><link rel="canonical" href="http://qiankanglai.me/2016/12/02/HIT/index.html"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://qiankanglai.me/2016/12/02/HIT/index.html",
    "headline": "HIT图形分析",
    "datePublished": "Fri Dec 02 2016 00:00:00 GMT+0800",
    "dateModified": "Tue Aug 07 2018 23:11:18 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Kanglai Qian",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "A game developer interested in rendering, with focus on Unity now."
    },
    "publisher": {
        "@type": "Organization",
        "name": "Loading &amp; Learning",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",Unrealnull",
    "description": "填坑向…之前和群里一个朋友讨论HIT的影子是咋实现的，后来验证了下发现自己之前想错了(逃。后来还看了下它的Bloom做法，效果还是挺好的。这里大力感谢@Hinatia和@LeLe给予的帮助和点拨，嘿嘿",
}</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-30309954-1","auto"),ga("send","pageview")</script></head><body id="scheme-Paradox" class="lazy"><div class="material-layout mdl-js-layout has-drawer is-upgraded"><main class="material-layout__content" id="main"><div id="top"></div><button class="MD-burger-icon sidebar-toggle"><span class="MD-burger-layer"></span></button> <button id="post-toc-trigger-btn" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">format_list_numbered</i></button><ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh;overflow-y:scroll"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#影子"><span class="post-toc-text">影子</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#UE4实现"><span class="post-toc-text">UE4实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Unity实现"><span class="post-toc-text">Unity实现</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#辉光"><span class="post-toc-text">辉光</span></a></li></ol></ul><div class="material-post_container"><div class="material-post mdl-grid"><div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col"><div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://pd3i7mmdp.bkt.clouddn.com//images/teaser/hit.png)"><p class="article-headline-p">HIT图形分析</p></div><div class="mdl-color-text--grey-700 mdl-card__supporting-text meta"><div id="author-avatar"><img src="http://pd3i7mmdp.bkt.clouddn.com//img/avatar.png" width="44px" height="44px" alt="Author Avatar"></div><div><strong>Kanglai Qian</strong> <span>12月 02, 2016</span></div><div class="section-spacer"></div><button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons" role="presentation">bookmark</i> <span class="visuallyhidden">bookmark</span></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button"><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Unreal/">Unreal</a></li></ul><button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons" role="presentation">share</i> <span class="visuallyhidden">share</span></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button"><a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=HIT图形分析&url=http://qiankanglai.me/2016/12/02/HIT/index.html&pic=http://qiankanglai.me/img/favicon.png&searchPic=false&style=simple" target="_blank"><li class="mdl-menu__item">分享到微博</li></a><a class="post_share-link" href="https://twitter.com/intent/tweet?text=HIT图形分析&url=http://qiankanglai.me/2016/12/02/HIT/index.html&via=Kanglai Qian" target="_blank"><li class="mdl-menu__item">分享到 Twitter</li></a><a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://qiankanglai.me/2016/12/02/HIT/index.html" target="_blank"><li class="mdl-menu__item">分享到 Facebook</li></a><a class="post_share-link" href="https://plus.google.com/share?url=http://qiankanglai.me/2016/12/02/HIT/index.html" target="_blank"><li class="mdl-menu__item">分享到 Google+</li></a></ul></div><div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out"><p>填坑向…之前和群里一个朋友讨论HIT的影子是咋实现的，后来验证了下发现自己之前想错了(逃。后来还看了下它的Bloom做法，效果还是挺好的。这里大力感谢@Hinatia和@LeLe给予的帮助和点拨，嘿嘿</p><a id="more"></a><h1 id="影子"><a href="#影子" class="headerlink" title="影子"></a>影子</h1><img src="http://pd3i7mmdp.bkt.clouddn.com/images/hit_shadow.jpg"><p>这里讲真，一开始我把HIT的影子当成<a href="/2016/11/14/unity-projector/" title="利用Projector实现动态阴影">利用Projector实现动态阴影</a>一样的做法，主要就是受到了这个图的“误导”。抓了下帧发现，一开始是只有角色绘制到一张depth texture</p><img src="http://pd3i7mmdp.bkt.clouddn.com/images/hit_shadow_caster.png"><p>在绘制影子的时候，只有部分场景能接受影子：我感觉是只有地面部分，像周围栏杆什么都是不受到动态阴影影响的。在绘制地面的时候有个传到shader的参数设为1，会读取shadowmap计算；否则是0，只要计算本身受到实时光和lightmap影响即可。</p><img src="http://pd3i7mmdp.bkt.clouddn.com/images/hit_shadow_receive.png"><h2 id="UE4实现"><a href="#UE4实现" class="headerlink" title="UE4实现"></a>UE4实现</h2><p>我找了下官方文档，估计HIT是直接使用了<a href="https://docs.unrealengine.com/latest/INT/Platforms/Mobile/Lighting/HowTo/ModulatedShadows/index.html" target="_blank" rel="noopener">Use Modulated Shadows</a>。这个应该是最原始的shadowmap的做法，根据<a href="https://docs.unrealengine.com/latest/INT/Platforms/Mobile/Lighting/#modulatedshadowing" target="_blank" rel="noopener">Lighting for Mobile Platforms</a>描述：</p><ul><li>Dynamic Shadowing是根据摄像机距离远近的多层CSM，而且能够和烘焙的静态阴影混合的很好</li><li>Modulated Shadowing感觉就是简单粗暴的shadowmap计算之后叠加一个颜色上去…</li></ul><p>HIT游戏里能很明显的发现玩家阴影和静态场景阴影格格不入… 我看了下shader和对应usf文件，应该就是在计算完模型受到光照的影响之后，直接从shadowmap里做了四次<code>texture2dLOD</code>平均之后混合一下了事儿。</p><h2 id="Unity实现"><a href="#Unity实现" class="headerlink" title="Unity实现"></a>Unity实现</h2><p>正好趁这个机会讨论了下对应Unity实现，然后发现我之前一直有两个知识点搞错了</p><ul><li>Unity中Shadow Caster是单独一个Pass，但是Shadow Receive是写在主Pass里的(我之前一直以为这也是单独的一个Pass)</li><li><a href="http://http.developer.nvidia.com/Cg/tex2Dproj.html" target="_blank" rel="noopener"><code>tex2DProj</code></a>最后一个参数直接提交了额外的深度比较：Coordinates to perform the lookup. The value used in the projection should be passed as the last component of the coordinate vector. The value used in the shadow comparison, if present, should be passed as the next-to-last component of the coordinate vector.</li></ul><p>在搞清楚这俩的基础上，对照乐乐的<a href="https://github.com/candycat1992/Unity_Shaders_Book/issues/49" target="_blank" rel="noopener">【常见问题】对9.4节Unity的阴影的补充说明（重要）</a>能比较轻松的看懂<code>AutoLight.cginc</code>里的代码：</p><figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#if defined(UNITY_NO_SCREENSPACE_SHADOWS)</span></span><br><span class="line"></span><br><span class="line">UNITY_DECLARE_SHADOWMAP(_ShadowMapTexture);</span><br><span class="line"><span class="meta">#define TRANSFER_SHADOW(a) a._ShadowCoord = mul( unity_World2Shadow[0], mul( _Object2World, v.vertex ) );</span></span><br><span class="line"></span><br><span class="line">inline fixed unitySampleShadow (unityShadowCoord4 shadowCoord)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#if defined(SHADOWS_NATIVE)</span></span><br><span class="line"></span><br><span class="line">    fixed shadow = UNITY_SAMPLE_SHADOW(_ShadowMapTexture, shadowCoord.xyz);</span><br><span class="line">    shadow = _LightShadowData.r + shadow * (<span class="number">1</span>-_LightShadowData.r);</span><br><span class="line">    <span class="keyword">return</span> shadow;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#else</span></span><br><span class="line"></span><br><span class="line">    unityShadowCoord dist = SAMPLE_DEPTH_TEXTURE_PROJ(_ShadowMapTexture, shadowCoord);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tegra is confused if we use _LightShadowData.x directly</span></span><br><span class="line">    <span class="comment">// with "ambiguous overloaded function reference max(mediump float, float)"</span></span><br><span class="line">    half lightShadowDataX = _LightShadowData.x;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(dist &gt; (shadowCoord.z/shadowCoord.w), lightShadowDataX);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#else // UNITY_NO_SCREENSPACE_SHADOWS</span></span><br><span class="line"></span><br><span class="line"><span class="type">sampler2D</span> _ShadowMapTexture;</span><br><span class="line"><span class="meta">#define TRANSFER_SHADOW(a) a._ShadowCoord = ComputeScreenPos(a.pos);</span></span><br><span class="line"></span><br><span class="line">inline fixed unitySampleShadow (unityShadowCoord4 shadowCoord)</span><br><span class="line">&#123;</span><br><span class="line">    fixed shadow = tex2Dproj( _ShadowMapTexture, UNITY_PROJ_COORD(shadowCoord) ).r;</span><br><span class="line">    <span class="keyword">return</span> shadow;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p>这里做几个补充说明：</p><ul><li><code>UNITY_NO_SCREENSPACE_SHADOWS</code>表示不使用屏幕空间阴影，所以移动平台看上半段就行</li><li><code>SHADOWS_NATIVE</code>宏表示硬件是否有原生shadow map支持，如果是ES2这种的话就走上半段的下半截，也就是取出深度信息之后自己比较<code>dist</code>; 否则直接用<code>UNITY_SAMPLE_SHADOW</code>取就行了</li></ul><p>ps. PCF模糊是在shadow caster的时候做的，而不是receive阶段，参考<code>Internal-PrePassCollectShadows.shader</code>里的代码。</p><p>pps. 这么看来Unity原生shadowmap的做法其实硬件特性利用的会比Projector好一些，咳咳，等他什么时候能让我更方便的控制模糊程度和范围我立刻<del>弃暗投明</del>转变立场，嗯嗯</p><h1 id="辉光"><a href="#辉光" class="headerlink" title="辉光"></a>辉光</h1><p>这个是我比较感兴趣的部分，因为UE4的后处理一条处理下来非常流畅，见Teaser部分对比。我之前抄了下它的Bloom还～</p><p>网上能找到一份资料<a href="https://cdn2.unrealengine.com/Resources/files/GDC2014_Next_Generation_Mobile_Rendering-2033767592.pdf" target="_blank" rel="noopener">Next-gen Mobile Rendering</a>里Mobile Post Processing Pipeline介绍了整体的流程，主要看Bloom Filter Tree部分。</p><p>我对照的看了下，它首先做了一次clamp+downsample(原图分辨率1280x720)到1/4大小，然后连着四次downsample分别是1/8，1/16，1/32，1/64；然后开始upsample，每次利用两个RT的内容混合回来。shader部分大概看了下确实是圆形的采样，和PPT里所说的正好对应：</p><ul><li>Standard hierarchical algorithm with some optimizations<br>– Down-sample from 1:1/4 res first (shared with light shaft)<br>– Then down-sample in 1:1/2 resolution passes<br>– Single pass circle based filter (instead of 2 pass Gaussian)<ul><li>15 taps on circle during down-sampling</li><li>7 taps for both circles during up-sample+merge pass</li></ul></li></ul><p>顺便它原始的RenderTexture是RGBA16F格式，渲染的时候就考虑了HDR。usf里面的注释里是提到了64bpp HDR、32bpp HDR using Mosaic encoding和32bpp HDR using RGBA encoding三种，其中mosaic我一直没找到具体资料，希望懂的朋友不吝赐教。</p><p>这样Bloom的好处在于不需要像Gaussian Blur或者SGX Blur需要每次横竖两个方向，而是每次都可以1/2分辨率往下降。正如PPT里所说的“Limited effect radius and less passes”。</p></div><div id="disqus-comment"><div id="disqus_thread"></div><style>.disqus_click_btn{line-height:30px;margin:0;min-width:50px;padding:0 14px;display:inline-block;font-family:Roboto,Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;text-transform:uppercase;letter-spacing:0;overflow:hidden;will-change:box-shadow;transition:box-shadow .2s cubic-bezier(.4,0,1,1),background-color .2s cubic-bezier(.4,0,.2,1),color .2s cubic-bezier(.4,0,.2,1);outline:0;cursor:pointer;text-decoration:none;text-align:center;vertical-align:middle;border:0;background:rgba(158,158,158,.2);box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);color:#fff;background-color:#757575;text-shadow:0;display:none}</style><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config=function(){this.page.url="http://qiankanglai.me/2016/12/02/HIT/",this.page.identifier="http://qiankanglai.me/2016/12/02/HIT/"}</script><script type="text/ls-javascript" id="disqus-lazy-load-script">$.ajax({
        url: 'https://disqus.com/next/config.json',
        timeout: 4000,
        type: 'GET',
        success: (function() {
            var d = document;
            var s = d.createElement('script');
            s.src = '//qiankanglai.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
            $('.disqus_click_btn').css('display','none');
        })(),
        error: function() {
          $('.disqus_click_btn').css('display','block');
        }
    });
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//qiankanglai.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.disqus_click_btn').css('display','none');
    });</script></div><style>#disqus-comment{background-color:#eee;padding:2pc}</style></div><nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col"><a href="/2016/12/03/unity-compiler2/" id="post_nav-newer" class="prev-content"><button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation"><i class="material-icons">arrow_back</i></button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 新篇</a><div class="section-spacer"></div><a href="/2016/12/01/adreno-profiler-again/" id="post_nav-older" class="next-content">旧篇 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation"><i class="material-icons">arrow_forward</i></button></a></nav></div></div><div class="sidebar-overlay"></div><aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation"><div id="sidebar-main"><div class="sidebar-header header-cover" style="background-image:url(http://pd3i7mmdp.bkt.clouddn.com//img/sidebar_header.png)"><div class="top-bar"></div><button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display:initial" data-upgraded=",MaterialButton,MaterialRipple"><i class="material-icons">clear_all</i> <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button><div class="sidebar-image"><img src="http://pd3i7mmdp.bkt.clouddn.com//img/avatar.png" alt="Kanglai Qian's avatar"></div><a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">qiankanglai@gmail.com <b class="caret"></b></a></div><ul class="nav sidebar-nav"><li class="dropdown"><ul id="settings-dropdown" class="dropdown-menu"></ul></li><li id="sidebar-first-li"><a href="/"><i class="material-icons sidebar-material-icons">home</i> 主页</a></li><li><a href="/tags" title="标签云"><i class="material-icons sidebar-material-icons">label</i> 标签云</a></li><li><a href="/timeline" title="时间轴"><i class="material-icons sidebar-material-icons">timeline</i> 时间轴</a></li><li><a href="/about" title="关于我"><i class="material-icons sidebar-material-icons">person</i> 关于我</a></li><li><a href="/links" title="友情链接"><i class="material-icons sidebar-material-icons">links</i> 友情链接</a></li></ul></div></aside><div id="back-to-top" class="toTop-wrap"><a href="#top" class="toTop"><i class="material-icons footer_top-i">expand_less</i></a></div><footer class="mdl-mini-footer" id="bottom"><div class="mdl-mini-footer--left-section sns-list"><a href="https://github.com/qiankanglai" target="_blank"><button class="mdl-mini-footer--social-btn social-btn footer-sns-github"><span class="visuallyhidden">Github</span></button></a><a href="https://www.zhihu.com/people/qian-kang-lai" target="_blank"><button class="mdl-mini-footer--social-btn social-btn footer-sns-zhihu"><span class="visuallyhidden">Zhihu</span></button></a></div><div id="copyright">Copyright&nbsp;©&nbsp;2012&nbsp;-<script type="text/javascript">var fd=new Date;document.write("&nbsp;"+fd.getFullYear()+"&nbsp;")</script>Loading & Learning</div><div class="mdl-mini-footer--right-section"><div><div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div><div class="footer-develop-div">Hosted by <a href="https://pages.coding.me" target="_blank" class="footer-develop-a">Coding Pages</a>&<a href="https://pages.github.com/" target="_blank" class="footer-develop-a">Github Pages</a></div><div class="footer-develop-div">CDN by <a href="https://www.qiniu.com/" target="_blank" class="footer-develop-a">Qiniu</a></div><div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div></div></div></footer><script>lsloader.load("lazyload_js","http://pd3i7mmdp.bkt.clouddn.com/js/lazyload.min.js",!0)</script><script>lsloader.load("js_js","http://pd3i7mmdp.bkt.clouddn.com/js/js.min.js",!0)</script><script>lsloader.load("np_js","https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js",!0)</script><script type="text/ls-javascript" id="NProgress-script">NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);</script><script>var agent=navigator.userAgent.toLowerCase();0<agent.indexOf("ucbrowser")&&(document.write('<link rel="stylesheet" href="/css/uc.css">'),alert("由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。"))</script><script>lsloader.load("prettify_js","https://cdn.bootcss.com/prettify/r298/prettify.min.js",!0)</script><script type="text/ls-javascript" id="window-load">$(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint').attr('style', 'overflow:auto;');
                prettyPrint();
                })</script><script type="text/ls-javascript" id="lazy-load">// Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });</script><script>!function(){for(var e=document.querySelectorAll('script[type="text/ls-javascript"]'),r=0;r<e.length;++r){var o=e[r];lsloader.runInlineScript(o.id,o.id)}}(),console.log("\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n","color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;","color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;")</script></main></div></body></html>